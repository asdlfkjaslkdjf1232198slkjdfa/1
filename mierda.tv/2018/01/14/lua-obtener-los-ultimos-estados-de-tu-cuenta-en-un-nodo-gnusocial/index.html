<!DOCTYPE html><html class="no-js" lang="es-ES"><head><meta http-equiv="content-type" content="text/html" charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" ><link rel="profile" href="http://gmpg.org/xfn/11"><link type="text/css" media="all" href="https://mierda.tv/wp-contenido/cache/autoptimize/css/autoptimize_dcbc99a7d03052a28dbf604173960da0.css" rel="stylesheet" /><title>Lua &#8211; Obtener los últimos estados de tu cuenta en un nodo GNUsocial &#8211; [ MIERDA TV ]</title><link rel="alternate" type="application/rss+xml" title="[ MIERDA TV ] &raquo; Feed" href="https://mierda.tv/feed/" /><link rel="alternate" type="application/rss+xml" title="[ MIERDA TV ] &raquo; RSS de los comentarios" href="https://mierda.tv/comments/feed/" /><link rel="alternate" type="application/rss+xml" title="[ MIERDA TV ] &raquo; Lua &#8211; Obtener los últimos estados de tu cuenta en un nodo GNUsocial RSS de los comentarios" href="https://mierda.tv/2018/01/14/lua-obtener-los-ultimos-estados-de-tu-cuenta-en-un-nodo-gnusocial/feed/" /><link rel='stylesheet' id='mcluhan-fonts-css'  href='https://fonts.googleapis.com/css?family=Archivo:400,400i,600,600i,700,700i&#038;subset=latin-ext' type='text/css' media='all' /> <script type='text/javascript' src='https://mierda.tv/wp-includes/js/jquery/jquery.js'></script> <link rel='https://api.w.org/' href='https://mierda.tv/wp-json/' /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://mierda.tv/xmlrpc.php?rsd" /><link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://mierda.tv/wp-includes/wlwmanifest.xml" /><link rel='prev' title='Bot gnusocial &#8211; Bot backup cuenta de twitter en Gnusocial' href='https://mierda.tv/2018/01/14/bot-gnusocial-bot-backup-cuenta-de-twitter-en-gnusocial/' /><link rel='next' title='&#8220;Desofuscar&#8221; con Geany cryptohive.js en GNU/Linux' href='https://mierda.tv/2018/01/16/desofuscar-con-geany-cryptohive-js-en-gnu-linux/' /><meta name="generator" content="WordPress 4.9.8" /><link rel="canonical" href="https://mierda.tv/2018/01/14/lua-obtener-los-ultimos-estados-de-tu-cuenta-en-un-nodo-gnusocial/" /><link rel='shortlink' href='https://mierda.tv/?p=5005' /><link rel="alternate" type="application/json+oembed" href="https://mierda.tv/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmierda.tv%2F2018%2F01%2F14%2Flua-obtener-los-ultimos-estados-de-tu-cuenta-en-un-nodo-gnusocial%2F" /> <script>jQuery( 'html' ).removeClass( 'no-js' ).addClass( 'js' );</script> <link rel="icon" href="https://mierda.tv/wp-contenido/uploads/2017/12/favicon-1.png" type="image/png"/><link rel="shortcut icon" href="https://mierda.tv/wp-contenido/uploads/2017/12/favicon.png" /></head><body class="post-template-default single single-post postid-5005 single-format-standard"><header class="site-header group"><h1 class="site-title"><a href="https://mierda.tv" class="site-name">[ MIERDA TV ]</a></h1><p class="site-description">NSFW Fanta text files</p><div class="nav-toggle"><div class="bar"></div><div class="bar"></div></div><div class="menu-wrapper"><ul class="main-menu desktop"><li id="menu-item-9007" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9007"><a href="https://mierda.tv/category/sistemas/"># SYSTEM</a></li><li id="menu-item-9006" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-9006"><a href="https://mierda.tv/category/codigo/"># CODE</a></li><li id="menu-item-9008" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9008"><a href="https://mierda.tv/category/juegos/"># GAMES</a></li><li id="menu-item-9012" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9012"><a href="https://mierda.tv/category/3d/"># 3D</a></li><li id="menu-item-9011" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9011"><a href="https://mierda.tv/category/musica/"># MUSIC</a></li><li id="menu-item-9010" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9010"><a href="https://mierda.tv/category/opinion/"># VIEW</a></li></ul></div><ul class="social-menu desktop"><li><a href="https://mierda.tv/?s="></a></li><li id="menu-item-10588" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-10588"><a title="Suscríbete al Boletín mensual de Mierda.tv" href="https://mierda.tv/suscribete-al-boletin-mensual-de-mierda-tv/"><span class="screen-reader-text">Suscríbete al Boletín mensual de Mierda.tv</span></a></li></ul></header><div class="mobile-menu-wrapper"><ul class="main-menu mobile"><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9007"><a href="https://mierda.tv/category/sistemas/"># SYSTEM</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-9006"><a href="https://mierda.tv/category/codigo/"># CODE</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9008"><a href="https://mierda.tv/category/juegos/"># GAMES</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9012"><a href="https://mierda.tv/category/3d/"># 3D</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9011"><a href="https://mierda.tv/category/musica/"># MUSIC</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9010"><a href="https://mierda.tv/category/opinion/"># VIEW</a></li><li class="toggle-mobile-search-wrapper"><a href="#" class="toggle-mobile-search">Buscar</a></li></ul><ul class="social-menu mobile"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-10588"><a title="Suscríbete al Boletín mensual de Mierda.tv" href="https://mierda.tv/suscribete-al-boletin-mensual-de-mierda-tv/"><span class="screen-reader-text">Suscríbete al Boletín mensual de Mierda.tv</span></a></li></ul></div><div class="mobile-search"><div class="untoggle-mobile-search"></div><form role="search" method="get" class="search-form" action="https://mierda.tv/"> <label for="search-form-5bab6038c098e"> <span class="screen-reader-text">Búsqueda para:</span> </label> <input type="search" id="search-form-5bab6038c098e" class="search-field" placeholder="Introduce tu búsqueda" value="" name="s" autocomplete="off" /> </button></form><div class="mobile-results"><div class="results-wrapper"></div></div></div><div class="search-overlay"><form role="search" method="get" class="search-form" action="https://mierda.tv/"> <label for="search-form-5bab6038c0a12"> <span class="screen-reader-text">Búsqueda para:</span> </label> <input type="search" id="search-form-5bab6038c0a12" class="search-field" placeholder="Introduce tu búsqueda" value="" name="s" autocomplete="off" /> </button></form></div><main class="site-content"><article class="post-5005 post type-post status-publish format-standard hentry category-codigo missing-thumbnail"><header class="entry-header section-inner"><h1 class="entry-title">Lua &#8211; Obtener los últimos estados de tu cuenta en un nodo GNUsocial</h2><div class="meta"> <time><a href="https://mierda.tv/2018/01/14/lua-obtener-los-ultimos-estados-de-tu-cuenta-en-un-nodo-gnusocial/" title="14 enero, 2018 11:08 pm">14 enero, 2018</a></time> <span> En <a href="https://mierda.tv/category/codigo/" rel="category tag"># CODE</a> </span></div></header><div class="entry-content section-inner"><p>En realidad es algo más que solamente obtener los últimos estados. Este código escrito en lua5.1 es la mezcla de varios posts que ya hemos publicado por aquí.</p><p>Hace no mucho <a href="https://mierda.tv/2017/12/19/scripts-en-lua-con-luacurl-para-descarga-de-archivos/">publicamos un articulo de como obtener archivos grandes con Lua</a>. Por ejemplo un archivo de un vídeo grande. Para ello usábamos luacurl. Luego publicamos <a href="https://mierda.tv/2017/12/19/publicar-estados-en-gnusocial-desde-un-script-en-lua/">otro post sobre como publicar en GNUSocial estados</a> en un programa escrito en Lua que también tiraba de luacurl.</p><p>Tanto en un post como en otro<strong> vimos como bajar archivos y guardarlos</strong> en nuestro disco así como <strong>la forma en la que podemos autenticarnos en un nodo gnusocial</strong> para publicar algo allí.</p><p>Publicar no requiere de bajar nada a disco pero si lo que buscamos es obtener el time line de estados de nuestro usuario <strong>vamos a tener que obtener un xml y parsearlo.</strong> Para esa tarea vamos a usar libXML.</p><p>Digamos pues que este ejemplo tira de libcurl y libXML para que todo funcione bien.<br /> Aparte de tener lua5.1 en el sistema instalado requerimos de las librerías:</p><ul><li><a href="https://luarocks.org/modules/luarocks/luacurl">https://luarocks.org/modules/luarocks/luacurl</a></li><li><a href="https://luarocks.org/modules/djerius/luaxml">https://luarocks.org/modules/djerius/luaxml</a></li></ul><p><strong>Si deseásemos almacenarlos en una base de datos mysql requeriríamos de luasql</strong>, puedes ver un ejemplo aquí: <a href="https://mierda.tv/2017/12/19/luasql-mysql-acceso-a-bases-de-datos-mariadb-desde-script-en-lua/">https://mierda.tv/2017/12/19/luasql-mysql-acceso-a-bases-de-datos-mariadb-desde-script-en-lua/</a></p><p><strong>En debian tirando de luarocks se pueden instalar tanto luacurl como luaxml</strong> con la peculiaridad de que luacurl puede que nos de algún problemilla que se soluciona leyendo <a href="https://mierda.tv/2017/12/19/scripts-en-lua-con-luacurl-para-descarga-de-archivos/">este post</a>.</p><p>Vamos al lio.</p><p><img src="https://mierda.tv/wp-contenido/uploads/2018/01/laststatus.png" alt="" width="1353" height="486" class="alignnone size-full wp-image-5011" /></p><p>Este código esta <strong>estructurado en 3 archivos</strong> y puedes bajarlo desde aquí: <a href="https://mierda.tv/wp-contenido/uploads/2018/01/LuaGetUserTimeLineGNUsocial.tar.gz">LuaGetUserTimeLineGNUsocial.tar.gz</a></p><ul><li>main.lua &#8212; El archivo principal que ejecutaremos con lua5.1</li><li>conf.lua &#8212; Contiene la configuración de usuario y nodo gnusocial</li><li>functions.lua  &#8212; 2 funciones, una para bajar el archivo xml del timeline del usuario y otra para parsearlo y mostrar los estados.</li></ul><p>Comenzamos viendo el archivo main.lua:</p><pre>
require("functions")

get_user_timeline()
show_last_status()
</pre><p>Como vemos es muy sencillo. Basicamente incluye el archivo functions.lua que es en el que están las funciones que luego llamamos en orden.<br /> Esas funciones son get_user_timeline() y show_last_status()</p><p>Veamos que hacen mirando el código de functions.lua :</p><pre>
function get_user_timeline()
	require("luacurl") -- https://luarocks.org/modules/luarocks/luacurl
	require("conf")

	headers = {
			"Accept: text/*",
			"Accept-Language: en",
			"Accept-Charset: iso-8859-1,*,utf-8",
			"Cache-Control: no-cache"
	}

	useragent = "Lua Music Social 0.1"
	userpwd = (user ..":" .. passwd)
	archivo = (user .. ".xml")
	f = assert(io.open(archivo, "w"))

	c = curl.new()
	c:setopt(curl.OPT_URL, hostname .. "/api/statuses/user_timeline/" .. user ..  ".xml")
	c:setopt(curl.OPT_HTTPGET, true)
	c:setopt(curl.OPT_ENCODING, "utf8")
	c:setopt(curl.OPT_USERPWD, userpwd)
	c:setopt(curl.OPT_USERAGENT, useragent)
	c:setopt(curl.OPT_SSL_VERIFYHOST, 0)
	c:setopt(curl.OPT_HTTPHEADER, 'headers')
	c:setopt(curl.OPT_BUFFERSIZE, 16000)-- 16K
	local t = {}
	c:setopt(curl.OPT_WRITEFUNCTION, function (param, buf)
		table.insert(t, buf)
		return #buf
	end)
	assert(c:perform())
	f:write(table.concat(t))
	c:close()
	io.close(f)
end

function show_last_status()
	require("LuaXML") -- https://luarocks.org/modules/djerius/luaxml
	require("conf")

	userTimeline = xml.load(user .. ".xml")
	status = {}

	for a, b in ipairs(userTimeline:find("statuses")) do
		for c, d in ipairs(userTimeline[a]:find("status")) do
			tag = d[0]
			valor = d[1]
			if tag == "text" then status.text = valor end
			if tag == "truncated" then status.truncated = valor end
			if tag == "created_at" then status.created_at = valor end
			if tag == "in_reply_to_status_id" then status.in_reply_to_status_id = valor end
			if tag == "uri" then status.uri = valor end
			if tag == "source" then status.source = valor end
			if tag == "source_link" then status.source_link = valor end
			if tag == "id" then status.id = valor end
			if tag == "in_reply_to_user_id" then status.in_reply_to_user_id = valor end
			if tag == "in_reply_to_screen_name" then status.in_reply_to_screen_name = valor end
			if tag == "geo" then status.geo = valor end
			if tag == "attachments" then status.attachments = valor end
			if tag == "user" then status.user = valor end
			if tag == "statusnet:html" then status.statusnet_html = valor end
			if tag == "statusnet:conversation_id" then status.statusnet_conversation_id = valor end
			if tag == "statusnet:in_groups" then status.statusnet_in_groups = valor end
			if tag == "external_url" then status.external_url = valor end
			if tag == "in_reply_to_profileurl" then status.in_reply_to_profileurl = valor end
			if tag == "in_reply_to_ostatus_uri" then status.in_reply_to_ostatus_uri = valor end
			if tag == "attentions" then status.attentions = valor end
			if tag == "fave_num" then status.fave_num = valor end
			if tag == "repeat_num" then status.repeat_num = valor end
			if tag == "is_post_verb" then status.is_post_verb = valor end
			if tag == "is_local" then status.is_local = valor end
			if tag == "favorited" then status.favorited = valor end
			if tag == "repeated" then status.repeated = valor end
		end
		print(status.text)
	end
end

</pre><p>Ambas funciones leen el archivo conf.lua que es este:</p><pre>
user = "tuusuario"
passwd = "tupassword"
hostname = "https://linuxinthenight.com" -- el host de tu nodo gnusocial
</pre><p>La función get_user_timeline() obtiene un archivo llamado como el usuario que hemos configurado en el archivo conf.lua. Por ejemplo si es benito pues bajará un archivo llamado benito.xml que contiene los últimos estados.</p><p>La función show_last_status() parsea todo el xml para mostrar lo que queramos mostrar. En el caso de este ejemplo solamente muestra el texto de los ultimos estados pero podría mostrar mucho más (por ejemplo el numero de favs y replys, la fecha de publicación, desde que cliente se ha realizado, &#8230;).</p><p>Esta función podría atacar a una base de datos e ir añadiendo los estados pero eso ya hace más complejo explicarlo por aquí.</p><p><strong>No hace falta decir que esto funciona directamente con Lua5.1 sin necesidad de love2d.</strong> Si usásemos love2D podríamos ya hacer algo mucho más vistoso en el que por ejemplo se puedan ver los avatares de estados, mostrar las imágenes adjuntas de estados, &#8230;</p><p>No es la finalidad de este post relatar como crear un cliente entero para GNUSocial pero en cierto modo sirve como comienzo (o eso espero).</p><p>Saludos cordiales.</p><div class='rp4wp-related-posts'><h3>Más mierda posiblemente relacionada</h3><ul><li><div class='rp4wp-related-post-content'> <a href='https://mierda.tv/2016/08/25/reducir-tamano-del-directorio-file-en-un-nodo-gnusocial/'>Reducir tamaño del directorio files en un nodo GNUSocial</a><p>Esto sirve igualmente para wordpress o drupal. La idea es que el directorio en el&hellip;</p></div></li><li><div class='rp4wp-related-post-content'> <a href='https://mierda.tv/2017/12/17/borrado-de-todos-los-estados-en-un-nodo-gnusocial/'>Borrado de todos los estados en un nodo gnusocial</a><p>Algunas veces sentimos la necesidad en redes sociales rollo gnusocial de eliminar todo lo escrito&hellip;</p></div></li><li><div class='rp4wp-related-post-content'> <a href='https://mierda.tv/2017/12/19/publicar-estados-en-gnusocial-desde-un-script-en-lua/'>Publicar estados en GNUsocial desde un script en Lua</a><p>En el anterior post se explica como se puede instalar lua en GNU/Linux y la&hellip;</p></div></li></ul></div></div><div class="post-pagination section-inner"><div class="previous-post"> <a href="https://mierda.tv/2018/01/14/bot-gnusocial-bot-backup-cuenta-de-twitter-en-gnusocial/" rel="prev"><span>Bot gnusocial &#8211; Bot backup cuenta de twitter en Gnusocial</span></a></div><div class="next-post"> <a href="https://mierda.tv/2018/01/16/desofuscar-con-geany-cryptohive-js-en-gnu-linux/" rel="next"><span>&#8220;Desofuscar&#8221; con Geany cryptohive.js en GNU/Linux</span></a></div></div><div class="section-inner wide"><div id="respond" class="comment-respond"><h3 id="reply-title" class="comment-reply-title">Deja un comentario <small><a rel="nofollow" id="cancel-comment-reply-link" href="/2018/01/14/lua-obtener-los-ultimos-estados-de-tu-cuenta-en-un-nodo-gnusocial/#respond" style="display:none;">Cancelar respuesta</a></small></h3><form action="https://mierda.tv/wp-comments-post.php" method="post" id="commentform" class="comment-form" novalidate><p class="comment-form-comment"><label for="comment">Comentario</label><textarea autocomplete="nope"  id="c9cd345614"  name="c9cd345614"   cols="45" rows="8" maxlength="65525" required="required"></textarea><textarea id="comment" aria-hidden="true" name="comment" autocomplete="nope" style="padding:0;clip:rect(1px, 1px, 1px, 1px);position:absolute !important;white-space:nowrap;height:1px;width:1px;overflow:hidden;" tabindex="-1"></textarea><script type="text/javascript">document.getElementById("comment").setAttribute( "id", "6869e4be280542f6008d9fdcbe18a8d4" );document.getElementById("c9cd345614").setAttribute( "id", "comment" );</script></p><p class="comment-form-author"><label for="author">Nombre <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" required='required' /></p><p class="comment-form-email"><label for="email">Correo electrónico <span class="required">*</span></label> <input id="email" name="email" type="email" value="" size="30" maxlength="100" aria-describedby="email-notes" required='required' /></p><p class="comment-form-url"><label for="url">Web</label> <input id="url" name="url" type="url" value="" size="30" maxlength="200" /></p><p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Publicar comentario" /> <input type='hidden' name='comment_post_ID' value='5005' id='comment_post_ID' /> <input type='hidden' name='comment_parent' id='comment_parent' value='0' /></p></form></div></div></div><footer class="site-footer section-inner"><p class="copyright">&copy; 2018 <a href="https://mierda.tv" class="site-name">[ MIERDA TV ]</a></p></footer></main> <script type="text/javascript">jQuery(document).ready( function() { jQuery.post( "https://mierda.tv/wp-admin/admin-ajax.php", { action : "entry_views", _ajax_nonce : "70537a5d8f", post_id : 5005 } ); } );</script> <script type='text/javascript'>var es_widget_page_notices = {"es_email_notice":"Por favor introduce direcci\u00f3n de correo electr\u00f3nico","es_success_message":"Suscripci\u00f3n correcta.","es_success_notice":"\u00a1Suscripci\u00f3n correcta! Consulta tu bandeja de entrada y confirma tu suscripci\u00f3n. Si no ves el correo en unos minutos, consulta la carpeta spam\/correo no deseado.","es_email_exists":"\u00a1Esa direcci\u00f3n de correo electr\u00f3nico ya existe!","es_error":"Ups. Ha sucedido un error inesperado.","es_invalid_email":"Direcci\u00f3n de correo electr\u00f3nico no v\u00e1lida","es_try_later":"Por favor, int\u00e9ntalo transcurridos unos minutos","es_ajax_url":"https:\/\/mierda.tv\/wp-admin\/admin-ajax.php"};</script> <script type='text/javascript'>var mcluhan_ajaxpagination = {"ajaxurl":"https:\/\/mierda.tv\/wp-admin\/admin-ajax.php","query_vars":"{\"page\":\"\",\"year\":\"2018\",\"monthnum\":\"01\",\"day\":\"14\",\"name\":\"lua-obtener-los-ultimos-estados-de-tu-cuenta-en-un-nodo-gnusocial\"}"};</script> <script type="text/javascript" defer src="https://mierda.tv/wp-contenido/cache/autoptimize/js/autoptimize_0f440c40192207511c15447e1fc97710.js"></script></body></html>