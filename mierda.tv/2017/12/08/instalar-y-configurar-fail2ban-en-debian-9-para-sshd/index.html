<!DOCTYPE html><html class="no-js" lang="es-ES"><head><meta http-equiv="content-type" content="text/html" charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" ><link rel="profile" href="http://gmpg.org/xfn/11"><link type="text/css" media="all" href="https://mierda.tv/wp-contenido/cache/autoptimize/css/autoptimize_dcbc99a7d03052a28dbf604173960da0.css" rel="stylesheet" /><title>Instalar y configurar fail2ban en Debian 9 para sshd &#8211; [ MIERDA TV ]</title><link rel="alternate" type="application/rss+xml" title="[ MIERDA TV ] &raquo; Feed" href="https://mierda.tv/feed/" /><link rel="alternate" type="application/rss+xml" title="[ MIERDA TV ] &raquo; RSS de los comentarios" href="https://mierda.tv/comments/feed/" /><link rel="alternate" type="application/rss+xml" title="[ MIERDA TV ] &raquo; Instalar y configurar fail2ban en Debian 9 para sshd RSS de los comentarios" href="https://mierda.tv/2017/12/08/instalar-y-configurar-fail2ban-en-debian-9-para-sshd/feed/" /><link rel='stylesheet' id='mcluhan-fonts-css'  href='https://fonts.googleapis.com/css?family=Archivo:400,400i,600,600i,700,700i&#038;subset=latin-ext' type='text/css' media='all' /> <script type='text/javascript' src='https://mierda.tv/wp-includes/js/jquery/jquery.js'></script> <link rel='https://api.w.org/' href='https://mierda.tv/wp-json/' /><link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://mierda.tv/xmlrpc.php?rsd" /><link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://mierda.tv/wp-includes/wlwmanifest.xml" /><link rel='prev' title='Ejemplo en Latex para libros' href='https://mierda.tv/2017/12/08/ejemplo-en-latex-para-libros/' /><link rel='next' title='Compilar OpenTTD para jugar online en Debian 9' href='https://mierda.tv/2017/12/10/compilar-openttd-para-jugar-online-en-debian-9/' /><meta name="generator" content="WordPress 4.9.8" /><link rel="canonical" href="https://mierda.tv/2017/12/08/instalar-y-configurar-fail2ban-en-debian-9-para-sshd/" /><link rel='shortlink' href='https://mierda.tv/?p=4115' /><link rel="alternate" type="application/json+oembed" href="https://mierda.tv/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmierda.tv%2F2017%2F12%2F08%2Finstalar-y-configurar-fail2ban-en-debian-9-para-sshd%2F" /> <script>jQuery( 'html' ).removeClass( 'no-js' ).addClass( 'js' );</script> <link rel="icon" href="https://mierda.tv/wp-contenido/uploads/2017/12/favicon-1.png" type="image/png"/><link rel="shortcut icon" href="https://mierda.tv/wp-contenido/uploads/2017/12/favicon.png" /></head><body class="post-template-default single single-post postid-4115 single-format-standard"><header class="site-header group"><h1 class="site-title"><a href="https://mierda.tv" class="site-name">[ MIERDA TV ]</a></h1><p class="site-description">NSFW Fanta text files</p><div class="nav-toggle"><div class="bar"></div><div class="bar"></div></div><div class="menu-wrapper"><ul class="main-menu desktop"><li id="menu-item-9007" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-9007"><a href="https://mierda.tv/category/sistemas/"># SYSTEM</a></li><li id="menu-item-9006" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9006"><a href="https://mierda.tv/category/codigo/"># CODE</a></li><li id="menu-item-9008" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9008"><a href="https://mierda.tv/category/juegos/"># GAMES</a></li><li id="menu-item-9012" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9012"><a href="https://mierda.tv/category/3d/"># 3D</a></li><li id="menu-item-9011" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9011"><a href="https://mierda.tv/category/musica/"># MUSIC</a></li><li id="menu-item-9010" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9010"><a href="https://mierda.tv/category/opinion/"># VIEW</a></li></ul></div><ul class="social-menu desktop"><li><a href="https://mierda.tv/?s="></a></li><li id="menu-item-10588" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-10588"><a title="Suscríbete al Boletín mensual de Mierda.tv" href="https://mierda.tv/suscribete-al-boletin-mensual-de-mierda-tv/"><span class="screen-reader-text">Suscríbete al Boletín mensual de Mierda.tv</span></a></li></ul></header><div class="mobile-menu-wrapper"><ul class="main-menu mobile"><li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-9007"><a href="https://mierda.tv/category/sistemas/"># SYSTEM</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9006"><a href="https://mierda.tv/category/codigo/"># CODE</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9008"><a href="https://mierda.tv/category/juegos/"># GAMES</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9012"><a href="https://mierda.tv/category/3d/"># 3D</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9011"><a href="https://mierda.tv/category/musica/"># MUSIC</a></li><li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-9010"><a href="https://mierda.tv/category/opinion/"># VIEW</a></li><li class="toggle-mobile-search-wrapper"><a href="#" class="toggle-mobile-search">Buscar</a></li></ul><ul class="social-menu mobile"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-10588"><a title="Suscríbete al Boletín mensual de Mierda.tv" href="https://mierda.tv/suscribete-al-boletin-mensual-de-mierda-tv/"><span class="screen-reader-text">Suscríbete al Boletín mensual de Mierda.tv</span></a></li></ul></div><div class="mobile-search"><div class="untoggle-mobile-search"></div><form role="search" method="get" class="search-form" action="https://mierda.tv/"> <label for="search-form-5bab60794aef4"> <span class="screen-reader-text">Búsqueda para:</span> </label> <input type="search" id="search-form-5bab60794aef4" class="search-field" placeholder="Introduce tu búsqueda" value="" name="s" autocomplete="off" /> </button></form><div class="mobile-results"><div class="results-wrapper"></div></div></div><div class="search-overlay"><form role="search" method="get" class="search-form" action="https://mierda.tv/"> <label for="search-form-5bab60794af8b"> <span class="screen-reader-text">Búsqueda para:</span> </label> <input type="search" id="search-form-5bab60794af8b" class="search-field" placeholder="Introduce tu búsqueda" value="" name="s" autocomplete="off" /> </button></form></div><main class="site-content"><article class="post-4115 post type-post status-publish format-standard hentry category-sistemas tag-debian tag-debian-9 tag-fail2ban tag-ssh tag-sshd missing-thumbnail"><header class="entry-header section-inner"><h1 class="entry-title">Instalar y configurar fail2ban en Debian 9 para sshd</h2><div class="meta"> <time><a href="https://mierda.tv/2017/12/08/instalar-y-configurar-fail2ban-en-debian-9-para-sshd/" title="8 diciembre, 2017 10:03 pm">8 diciembre, 2017</a></time> <span> En <a href="https://mierda.tv/category/sistemas/" rel="category tag"># SYSTEM</a> </span></div></header><div class="entry-content section-inner"><p>Esto siempre viene bien para paliar un poco los intentos desde la misma IP de acceder vía ssh a nuestras maquinas (independientemente del tipo de acceso que se tenga configurado).<br /> Partimos de una instalación fresca de Debian 9. Actualizamos el sistema y tras ello reiniciamos para hacer login como root.<br /> &nbsp;<br /> Instalaremos algunas dependencias por si acaso no las tenemos ya satisfechas. Supuestamente se parte de que si que tenemos instalado un servicio ssh.<br /> &nbsp;</p><pre>
# apt update && apt upgrade -y
# apt-get install rsyslog iptables nano
# shutdown -r now
</pre><p>&nbsp;<br /> Ahora nos vamos a editar el archivo de configuración /etc/ssh/sshd para que escuche por el puerto 22341 o el que decidamos.<br /> Es una buena practica cambiar el puerto 22 para que no esté el servicio tan accesible de primeras ya que los escaneos automáticos irán a buscar el servicio allí.<br /> &nbsp;<br /> Esto se hace des-comentando la linea del puerto en el archivo /etc/ssh/sshd utilizando para ello el editor que más rabia nos de (por ejemplo nano, vi, vim, &#8230;):<br /> &nbsp;</p><pre>
#Port 22
</pre><p>&nbsp;<br /> Una vez des-comentada y con el nuevo puerto guardaremos los cambios y tendría que quedar esa línea así:<br /> &nbsp;</p><pre>
Port 22341
</pre><p>&nbsp;<br /> Es importante revisar si en el archivo sshd que hemos tocado existe esto:<br /> &nbsp;</p><pre>
# Logging
#SyslogFacility AUTH
#LogLevel INFO
</pre><p>&nbsp;<br /> Y si está comentado lo vamos a des-comentar dejando la cosa así:<br /> &nbsp;</p><pre>
# Logging
SyslogFacility AUTH
LogLevel INFO
</pre><p>&nbsp;<br /> Una vez guardados los cambios reiniciamos el servicio:<br /> &nbsp;</p><pre>
# /etc/init.d/sshd restart
</pre><p>&nbsp;<br /> Y comprobamos que escucha en el puerto 22341 (o el que indicásemos anteriormente) así:<br /> &nbsp;</p><pre>
# netstat -atunp | grep "sshd" | grep "LISTEN" | grep "22341"
</pre><p>&nbsp;</p><h3>Reglas IPTABLES</h3><p>&nbsp;<br /> Ahora vamos a actualizar las reglas de iptables:<br /> &nbsp;</p><pre>
# iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
# iptables -A INPUT -p tcp --dport 22 -j DROP
# iptables -A INPUT -p tcp --dport 22341 -j ACCEPT
</pre><p>&nbsp;<br /> Podemos comprobarlas así:<br /> &nbsp;</p><pre>
# iptables -S
</pre><p>&nbsp;<br /> Y guardar las reglas para que los cambios queden persistentes:<br /> &nbsp;</p><pre>
iptables-save > /etc/iptables.up.rules
touch /etc/network/if-pre-up.d/iptables
chmod +x /etc/network/if-pre-up.d/iptables
echo '#!/bin/sh' >> /etc/network/if-pre-up.d/iptables
echo '/sbin/iptables-restore < /etc/iptables.up.rules' >> /etc/network/if-pre-up.d/iptables
</pre><p>&nbsp;<br /> Una vez llegados a este punto tendremos que reiniciar el sistema para comprobar que accedemos vía ssh desde el puerto 22341 y que al entrar las reglas siguen. Reiniciamos por ejemplo escribiendo &#8220;reboot&#8221; o &#8220;shutdown -r now&#8221; (sin las comillas).<br /> &nbsp;</p><h3>Instalamos ahora si fail2ban y lo configuramos</h3><p>&nbsp;<br /> Es cierto que no es necesario meter tantos reinicios. Con reiniciar los servicios muchas veces es suficiente no obstante lo que se busca en comprobar que todo va bien tras un reinicio y por tanto por eso indico que reiniciemos.<br /> &nbsp;<br /> Dicho eso si todo va bien es el momento de instalar y configurar fail2ban para el servicio sshd.<br /> &nbsp;</p><pre>
# apt install fail2ban -y
</pre><p>&nbsp;<br /> Si nos fallase al instalar es posible que sea por que nos falte el archivo /var/log/auth.log . En tal caso:<br /> &nbsp;</p><pre>
# touch /var/log/auth.log
# chown root:adm /var/log/auth.log
# /etc/init.d/rsyslog restart
# /etc/init.d/sshd restart
# /etc/init.d/fail2ban
</pre><p>&nbsp;<br /> Una vez instalado fail2ban tendremos si ejecutamos como root &#8220;iptables -S&#8221; algo así:<br /> &nbsp;</p><pre>
-A INPUT -p tcp -m multiport --dports 22 -j f2b-sshd
</pre><p>&nbsp;<br /> Con lo cual hemos de configurar el puerto y eso vamos a hacerlo en el archivo /etc/fail2ban/jail.d/defaults-debian.conf añadiendo a la sección de [sshd]:<br /> &nbsp;</p><pre>
port = 22341
</pre><p>&nbsp;<br /> En el archivo /etc/fail2ban/jail.conf veremos estos valores:<br /> &nbsp;</p><pre>
bantime  = 600
maxretry = 5
</pre><p>&nbsp;<br /> Podemos alterarlos si queremos limitar los intentos de conexión a 3 por ejemplo y subir el tiempo de baneo (segundos).<br /> &nbsp;<br /> Una vez realizado reiniciaremos el servicio fail2ban y miraremos las reglas de iptables con iptables -L o iptables -S .<br /> Si todo va bien reiniciamos la maquina e intentamos acceder varias veces hasta que nos bloque la IP.<br /> Si lo hace es que todo va bien :).<br /> &nbsp;</p><h3>Eliminar una IP que ha sido bloqueada</h3><p>&nbsp;<br /> La forma guay es así:<br /> &nbsp;</p><pre>
iptables -S
fail2ban-client status
fail2ban-client set sshd unbanip 88.31.11.27
</pre><p>&nbsp;<br /> Primero miramos la IP con iptables -S y luego el nombre de la jaula con fail2ban-client status para finalmente des-banear la ip.<br /> &nbsp;<br /> Y eso es todo amigos.<br /> &nbsp;<br /> Saludos cordiales.</p><div class='rp4wp-related-posts'><h3>Más mierda posiblemente relacionada</h3><ul><li><div class='rp4wp-related-post-content'> <a href='https://mierda.tv/2018/01/10/instalar-redmine-en-debian-9-desde-docker/'>Instalar redmine desde docker</a><p>Hace un mes publicamos como instalar Redmine con thin y nginx. Concretamente aquí. Lo cierto&hellip;</p></div></li><li><div class='rp4wp-related-post-content'> <a href='https://mierda.tv/2018/01/10/instalar-docker-sobre-debian-9-stretch/'>Instalar Docker sobre debian 9 stretch</a><p>En diciembre del 2016 publicamos un post sobre como instalar docker sobre debian 8. Este&hellip;</p></div></li><li><div class='rp4wp-related-post-content'> <a href='https://mierda.tv/2016/12/08/instalar-docker-sobre-debian-8-jessie/'>Instalar Docker sobre debian 8 jessie</a><p>Tras la charla del señor miyagi en la brecha digital me entró el gusanillo de&hellip;</p></div></li></ul></div></div><div class="meta bottom section-inner"><p class="tags"> #<a href="https://mierda.tv/tag/debian/" rel="tag">debian</a> #<a href="https://mierda.tv/tag/debian-9/" rel="tag">debian 9</a> #<a href="https://mierda.tv/tag/fail2ban/" rel="tag">fail2ban</a> #<a href="https://mierda.tv/tag/ssh/" rel="tag">ssh</a> #<a href="https://mierda.tv/tag/sshd/" rel="tag">sshd</a></p></div><div class="post-pagination section-inner"><div class="previous-post"> <a href="https://mierda.tv/2017/12/08/ejemplo-en-latex-para-libros/" rel="prev"><span>Ejemplo en Latex para libros</span></a></div><div class="next-post"> <a href="https://mierda.tv/2017/12/10/compilar-openttd-para-jugar-online-en-debian-9/" rel="next"><span>Compilar OpenTTD para jugar online en Debian 9</span></a></div></div><div class="section-inner wide"><div id="respond" class="comment-respond"><h3 id="reply-title" class="comment-reply-title">Deja un comentario <small><a rel="nofollow" id="cancel-comment-reply-link" href="/2017/12/08/instalar-y-configurar-fail2ban-en-debian-9-para-sshd/#respond" style="display:none;">Cancelar respuesta</a></small></h3><form action="https://mierda.tv/wp-comments-post.php" method="post" id="commentform" class="comment-form" novalidate><p class="comment-form-comment"><label for="comment">Comentario</label><textarea autocomplete="nope"  id="d4aa33e958"  name="d4aa33e958"   cols="45" rows="8" maxlength="65525" required="required"></textarea><textarea id="comment" aria-hidden="true" name="comment" autocomplete="nope" style="padding:0;clip:rect(1px, 1px, 1px, 1px);position:absolute !important;white-space:nowrap;height:1px;width:1px;overflow:hidden;" tabindex="-1"></textarea><script type="text/javascript">document.getElementById("comment").setAttribute( "id", "c662b9c2c2515302e05025565d3c4e46" );document.getElementById("d4aa33e958").setAttribute( "id", "comment" );</script></p><p class="comment-form-author"><label for="author">Nombre <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" required='required' /></p><p class="comment-form-email"><label for="email">Correo electrónico <span class="required">*</span></label> <input id="email" name="email" type="email" value="" size="30" maxlength="100" aria-describedby="email-notes" required='required' /></p><p class="comment-form-url"><label for="url">Web</label> <input id="url" name="url" type="url" value="" size="30" maxlength="200" /></p><p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Publicar comentario" /> <input type='hidden' name='comment_post_ID' value='4115' id='comment_post_ID' /> <input type='hidden' name='comment_parent' id='comment_parent' value='0' /></p></form></div></div></div><footer class="site-footer section-inner"><p class="copyright">&copy; 2018 <a href="https://mierda.tv" class="site-name">[ MIERDA TV ]</a></p></footer></main> <script type="text/javascript">jQuery(document).ready( function() { jQuery.post( "https://mierda.tv/wp-admin/admin-ajax.php", { action : "entry_views", _ajax_nonce : "70537a5d8f", post_id : 4115 } ); } );</script> <script type='text/javascript'>var es_widget_page_notices = {"es_email_notice":"Por favor introduce direcci\u00f3n de correo electr\u00f3nico","es_success_message":"Suscripci\u00f3n correcta.","es_success_notice":"\u00a1Suscripci\u00f3n correcta! Consulta tu bandeja de entrada y confirma tu suscripci\u00f3n. Si no ves el correo en unos minutos, consulta la carpeta spam\/correo no deseado.","es_email_exists":"\u00a1Esa direcci\u00f3n de correo electr\u00f3nico ya existe!","es_error":"Ups. Ha sucedido un error inesperado.","es_invalid_email":"Direcci\u00f3n de correo electr\u00f3nico no v\u00e1lida","es_try_later":"Por favor, int\u00e9ntalo transcurridos unos minutos","es_ajax_url":"https:\/\/mierda.tv\/wp-admin\/admin-ajax.php"};</script> <script type='text/javascript'>var mcluhan_ajaxpagination = {"ajaxurl":"https:\/\/mierda.tv\/wp-admin\/admin-ajax.php","query_vars":"{\"page\":\"\",\"year\":\"2017\",\"monthnum\":\"12\",\"day\":\"08\",\"name\":\"instalar-y-configurar-fail2ban-en-debian-9-para-sshd\"}"};</script> <script type="text/javascript" defer src="https://mierda.tv/wp-contenido/cache/autoptimize/js/autoptimize_0f440c40192207511c15447e1fc97710.js"></script></body></html>